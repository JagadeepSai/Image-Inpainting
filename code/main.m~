clc;
clear all;
close all;
tic;
<<<<<<< HEAD
dir = '../data/dataset/c23';
image = imread( sprintf('%s%s',dir,'_input.png'));
=======
% dir = '../data/dataset/c38';
% image = imread( sprintf('%s%s',dir,'_input.png'));
>>>>>>> 3a18a7bd15333995ee9cef8b3b0ee8cf885765cb
% image =  imgaussfilt(image,2);

image = imread('../data/images/c1.jpg');
image=rgb2ycbcr(image);
image = double(image);
imshow(image);


debug = 0;
% figure(1), hold off, imagesc(image);

% [x, y] = ginput;               
% mask = 255-255*poly2mask(x, y, size(image, 1), size(image, 2));


<<<<<<< HEAD
mask = imread(sprintf('%s%s',dir,'_mask.png'));
=======
% mask = imread(sprintf('%s%s',dir,'_/mask.png'));
>>>>>>> 3a18a7bd15333995ee9cef8b3b0ee8cf885765cb
% mask = 255-mask;
mask = imread('');
mask = double(mask);
% mask = mask > 0; 


<<<<<<< HEAD
psi = 8;
window = 40;
=======
psi = 10;
window = 50;
>>>>>>> 3a18a7bd15333995ee9cef8b3b0ee8cf885765cb
alpha=255;
width=3;
grad_window = 6;
f = 3;

[rows,cols] = size(mask);
confidence_mat = double(mask > 0);  

while 1
    priority_mat = zeros(rows,cols);
%     [bx,by] = find_border(mask);
%     border_list = [bx,by];
        border_list = find_border(mask);
    if size(border_list) == [0,0]
       break
    end
    
    [n,m] = size(border_list);
    max_p_x = 0;
    max_p_y = 0;
    max_p = -1;
    G = grad1(image,3);
    
    %normals 
    % [Nx, Ny] = gradient(double(~mask));
%     toc;
    for i = 1:n
        x = border_list(i,1);
        y = border_list(i,2);
        cp = confidence(psi,x,y,confidence_mat);
        dt = isophote1(x,y,G,grad_window,mask);
        
        % norm_vector = [Nx(x,y), Ny(x,y)]';
        % norm_vector = norm_vector/norm(norm_vector);
        % norm_vector(~isfinite(norm_vector)) = 0;
        
        norm_vector = norm_vec(border_list,[x,y],width);
        dp = abs(dt'*norm_vector)/alpha;
%         prio = cp*dp;
<<<<<<< HEAD
%           prio = cp*dp;
        prio = [cp,f*dp];
        prio = sum(prio);
=======
          prio = cp*dp;
%         prio = [cp,f*dp];
%         prio = sum(prio);
>>>>>>> 3a18a7bd15333995ee9cef8b3b0ee8cf885765cb

        priority_mat(x,y) = prio;
        if prio > max_p
            max_p_x = x;
            max_p_y = y;    
            max_p = prio;
        end
    end
%     toc;
    confidence_mat(max_p_x,max_p_y) = confidence(psi,max_p_x,max_p_y,confidence_mat);
    [min_i,min_j] = patch_fill(max_p_x,max_p_y,image,mask,window,psi,confidence_mat);
    cp = confidence(psi,max_p_x,max_p_y,confidence_mat);
%     toc;
    
    
    top = max_p_x-max(max_p_x-psi,1);
    bottom = min(max_p_x+psi,rows)-max_p_x;
    left = max_p_y-max(max_p_y-psi,1);
    right = min(max_p_y+psi,cols)-max_p_y;
    
    for i=-top:bottom
        for j=-left:right
            if mask(max_p_x+i,max_p_y+j) == 0
               image(max_p_x+i,max_p_y+j,:) = image(min_i+i,min_j+j,:);
               mask(max_p_x+i,max_p_y+j)=255;
               confidence_mat(max_p_x+i,max_p_y+j) = cp;
            end
        end
    end
 toc;
<<<<<<< HEAD

if(debug == 1) 
    figure(1);
    imshow(ycbcr2rgb((uint8(image))));

=======
figure(1);
imshow(ycbcr2rgb(uint8(image)));

if(debug == 1) 
    figure(1);
    imshow(ycbcr2rgb((uint8(image))));

>>>>>>> 3a18a7bd15333995ee9cef8b3b0ee8cf885765cb
    % figure(2);
    % [rows,cols] = size(mask);
    I = zeros(rows, cols);
    for i=1:rows
        for j=1:cols
            if(mask(i,j)==0)
                I(i,j) = norm(isophote(i, j, G, grad_window, mask));
            end
        end
    end
    % imshow(I); colormap(gray);

    figure(3);
    imagesc(priority_mat);colormap(gray);

    figure(4);
    imagesc(confidence_mat); colormap(gray);
end
end
imwrite(ycbcr2rgb((uint8(image))), sprintf('%s%s',dir,'_output.png'));
% image= hsv2rgb(image);
toc;
